<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.11.0/d3.min.js"></script>
<dom-module id="pie-chart" attributes="url">
    <template>
         <style>
            :host {
                display: block;
                height: 400px;
            }
            text {
              fill: white;
            }
            .controls {
              display: inline-block;
              margin: 0 0 0 20px;
            }
            svg {
              float: right;
              margin: 0 20px 0 0;
            }
            .arc path {
              stroke: #fff;
            }
        </style>
        <div class="controls">
          <template repeat="{{d in data}}">
            <p><label for="input">{{d.type}}: </label>
            <input id="input"
            type="range"
            value="{{d.amount}}"
            min="0" max="500"
            on-input="{{refreshChart}}"> ${{d.amount}}</p>
          </template>
        </div>
        <svg id="svg"></svg>
    </template>
    <script>
      class PieChart extends Polymer.Element {
        static get is() {return 'pie-chart';}

        ready() {
          super.ready();
          setTimeout(function() {
            var d3 = window.d3;
            var width = 500,
                height = 500,
                radius = Math.min(width, height) / 2;

            this.color = d3.scaleOrdinal()
                .range(["green", "orange", "blue", "red"]);

            this.arc = d3.arc()
                .outerRadius(radius - 10)
                .innerRadius(0);

            this.pie = d3.pie()
                .sort(null)
                .value(function(d) { return d.amount; });

            this.svg = d3.select(this.$.svg)
                .attr("width", width)
                .attr("height", height)
              .append("g")
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");



            var me = this;
            d3.csv("../data/data.csv", function (error, data) {
              console.log(data);
              me.data = data;
              me.data.forEach(function(d) {
                d.amount = +d.amount;
              });

              me.g = me.svg.selectAll(".arc")
                  .data(me.pie(me.data))
                .enter().append("g")
                  .attr("class", "arc");

              me.g.append("path")
                  .attr("d", me.arc)
                  .style("fill", function(d) { return me.color(d.data.type); });

              me.g.append("text")
                  .attr("transform", function(d) { return "translate(" + me.arc.centroid(d) + ")"; })
                  .attr("dy", ".35em")
                  .style("text-anchor", "middle")
                  .text(function(d) { return d.data.type; });

              me.g.data(me.pie(me.data))
                .select("path").attr("d", me.arc);

              me.g.select("text")
                .attr("transform", function(d) { return "translate(" + me.arc.centroid(d) + ")"; });
            });


          }.bind(this),0);
        }

        _refreshChart() {
          var me = this;

          me.g.data(me.pie(me.data))
            .select("path").attr("d", me.arc);

          me.g.select("text")
            .attr("transform", function(d) { return "translate(" + me.arc.centroid(d) + ")"; });
        }

        _urlChanged(oldValue, newValue) {
          if(newValue && oldValue) {
            this.getData();
          }
        };

      }
      customElements.define(PieChart.is, PieChart);
    </script>
</dom-module>